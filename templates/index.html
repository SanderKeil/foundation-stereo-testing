<!DOCTYPE html>
<html>

<head>
    <title>FoundationStereo Live Stream</title>
    <style>
        body {
            font-family: sans-serif;
            background: #222;
            color: white;
            text-align: center;
        }

        .grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .box {
            background: #333;
            padding: 10px;
            border-radius: 8px;
        }

        img {
            width: 480px;
            height: auto;
            border-radius: 4px;
        }

        h2 {
            margin: 5px 0;
            font-size: 1.2rem;
        }

        .controls {
            margin: 20px;
        }

        input {
            padding: 8px;
            width: 300px;
        }

        button {
            padding: 8px 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }

        #latency {
            color: #0f0;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>FoundationStereo Live Interface</h1>

    <div class="controls">
        <label>Cloud API URL:</label>
        <input type="text" id="apiUrl" value="{{ cloud_url }}" placeholder="Cloud URL from local_app.py" readonly
            style="width: 400px; color: #888;">
        <button onclick="startStream()">Start Inference</button>
        <p>Latency: <span id="latency">0</span> ms</p>
        <div id="statusLog"
            style="margin-top: 10px; color: #aaa; font-size: 0.9em; height: 100px; overflow-y: scroll; border: 1px solid #444; padding: 5px;">
            Ready. Click Start.</div>
    </div>

    <div class="grid">
        <div class="box">
            <h2>Left Camera (Local)</h2>
            <!-- Directly stream from local endpoint if implemented, or just use JS to refresh? 
                 Actually, FastAPI StreamingResponse is easiest for raw video.
            -->
            <img src="/video_feed/left" />
            <!-- <p>Raw feeds hidden to save bandwidth/local CPU (TODO)</p> -->
        </div>

        <div class="box">
            <h2>Depth Prediction (Cloud)</h2>
            <img id="depthResult" src="" alt="Waiting for stream..." />
        </div>
    </div>

    <script>
        let ws;

        function log(msg) {
            const el = document.getElementById("statusLog");
            el.innerHTML += "<div>" + new Date().toLocaleTimeString() + ": " + msg + "</div>";
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        function startStream() {
            log("Initializing connection...");
            const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            let host = window.location.host;
            if (host.includes("0.0.0.0")) {
                host = host.replace("0.0.0.0", "127.0.0.1");
                log("Corrected invalid host 0.0.0.0 to 127.0.0.1");
            }
            const wsUrl = `${protocol}//${host}/ws/inference`;
            log("Connecting to: " + wsUrl);

            ws = new WebSocket(wsUrl);
            ws.binaryType = "arraybuffer";

            let lastTime = Date.now();

            ws.onopen = () => {
                log("Connected to Local Backend! Waiting for frames...");
            };

            ws.onerror = (e) => {
                log("WebSocket Error: " + JSON.stringify(e));
            };

            ws.onmessage = (event) => {
                // Receive result image bytes
                const arrayBuffer = event.data;
                const blob = new Blob([arrayBuffer], { type: "image/jpeg" });
                const url = URL.createObjectURL(blob);

                document.getElementById('depthResult').src = url;

                // Calc latency (approx loop time)
                const now = Date.now();
                const diff = now - lastTime;
                lastTime = now;
                document.getElementById('latency').innerText = diff;
                // log("Frame received: " + diff + "ms");
            };

            ws.onclose = (e) => {
                log("Disconnected. Code: " + e.code + " Reason: " + e.reason);
            }
        }
    </script>
</body>

</html>