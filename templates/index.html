<!DOCTYPE html>
<html>

<head>
    <title>FoundationStereo Live Stream</title>
    <style>
        body {
            font-family: sans-serif;
            background: #222;
            color: white;
            text-align: center;
        }

        .grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            max-width: 100%;
        }

        .box {
            background: #333;
            padding: 10px;
            border-radius: 8px;
        }

        img {
            width: 480px;
            height: auto;
            border-radius: 4px;
        }

        h2 {
            margin: 5px 0;
            font-size: 1.2rem;
        }

        .controls {
            margin: 20px;
        }

        input {
            padding: 8px;
            width: 300px;
        }

        button {
            padding: 8px 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }

        #latency {
            color: #0f0;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>FoundationStereo Live Interface</h1>

    <div class="controls">
        <label>Cloud API URL:</label>
        <input type="text" id="apiUrl" value="{{ cloud_url }}" placeholder="Cloud URL from local_app.py" readonly
            style="width: 400px; color: #888;">
        <button onclick="startStream()">Start Inference</button>
        <p>Latency: <span id="latency">0</span> ms</p>
        <div id="statusLog"
            style="margin-top: 10px; color: #aaa; font-size: 0.9em; height: 100px; overflow-y: scroll; border: 1px solid #444; padding: 5px;">
            Ready. Click Start.</div>
    </div>

    <!-- NEW MANUAL CALIBRATION CONTROLS -->
    <div class="controls" style="background:#444; padding:15px; border-radius:8px; display:inline-block;">
        <h3>ðŸ”§ Manual Calibration (Vertical Shift)</h3>
        <p style="font-size:0.9em; color:#ccc; margin-bottom:10px;">
            The model fails if the cameras aren't perfectly aligned vertically. <br>
            <b>Slowly</b> drag this slider until the depth map suddenly "pops" into focus.
        </p>
        <div style="display:flex; align-items:center; gap:10px;">
            <label>Right Camera Vertical Shift:</label>
            <input type="range" id="shiftSlider" min="-100" max="100" value="0" step="1" style="width:300px;"
                oninput="updateShift(this.value)">
            <input type="number" id="shiftValue" value="0" style="width: 60px; padding:5px;"
                onchange="updateShift(this.value)">
            <span>pixels</span>
        </div>
    </div>

    <div class="grid">
        <div class="box">
            <h2>Left Camera (Local)</h2>
            <img src="/video_feed/left" />
        </div>

        <div class="box">
            <h2>Right Camera (Local)</h2>
            <img src="/video_feed/right" />
        </div>

        <div class="box">
            <h2>Depth Prediction (Cloud)</h2>
            <img id="depthResult" src="" alt="Waiting for stream..." />
        </div>
    </div>

    <script>
        let ws;

        function log(msg) {
            const el = document.getElementById("statusLog");
            el.innerHTML += "<div>" + new Date().toLocaleTimeString() + ": " + msg + "</div>";
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        function startStream() {
            log("Initializing connection...");
            const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            let host = window.location.host;
            if (host.includes("0.0.0.0")) {
                host = host.replace("0.0.0.0", "127.0.0.1");
                log("Corrected invalid host 0.0.0.0 to 127.0.0.1");
            }
            const wsUrl = `${protocol}//${host}/ws/inference`;
            log("Connecting to: " + wsUrl);

            ws = new WebSocket(wsUrl);
            ws.binaryType = "arraybuffer";

            let lastTime = Date.now();

            ws.onopen = () => {
                log("Connected to Local Backend! Waiting for frames...");
            };

            ws.onerror = (e) => {
                log("WebSocket Error: " + JSON.stringify(e));
            };

            ws.onmessage = (event) => {
                // Receive result image bytes
                const arrayBuffer = event.data;
                const blob = new Blob([arrayBuffer], { type: "image/jpeg" });
                const url = URL.createObjectURL(blob);

                document.getElementById('depthResult').src = url;

                // Calc latency (approx loop time)
                const now = Date.now();
                const diff = now - lastTime;
                lastTime = now;
                document.getElementById('latency').innerText = diff;
                // log("Frame received: " + diff + "ms");
            };

            ws.onclose = (e) => {
                log("Disconnected. Code: " + e.code + " Reason: " + e.reason);
            }
        }
        function updateShift(val) {
            document.getElementById('shiftSlider').value = val;
            document.getElementById('shiftValue').value = val;

            fetch('/set_shift', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ shift: parseInt(val) })
            }).then(r => console.log("Shift updated to " + val));
        }
    </script>
</body>

</html>